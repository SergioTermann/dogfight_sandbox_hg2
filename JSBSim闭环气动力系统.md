# JSBSim 闭环气动力系统说明

## 💡 您的理解完全正确！

**关键概念：**
1. **舵面偏转** → 产生气动力矩 → **改变姿态**
2. **姿态改变** → 改变迎角/侧滑角 → **改变气动力**
3. **气动力改变** → 影响加速度和轨迹
4. **这是一个闭环！每一帧都在循环**

---

## 🔄 JSBSim 的闭环系统

### 每帧 `fdm.run()` 内部的完整流程：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
JSBSim 一帧的完整计算循环 (fdm.run())
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

输入：
  - 当前状态 (t)
    ├─ 位置: (x, y, z)
    ├─ 速度: (u, v, w) 机体坐标
    ├─ 姿态: (φ, θ, ψ) roll, pitch, yaw
    └─ 角速度: (p, q, r)
  
  - 控制输入
    ├─ throttle (油门)
    ├─ elevator (升降舵)
    ├─ aileron (副翼)
    ├─ rudder (方向舵)
    └─ flaps (襟翼)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第1步：计算气流角度（基于当前姿态和速度）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1.1 迎角 (Angle of Attack)
    α = atan2(w, u)
    // w: 垂直速度分量
    // u: 前向速度分量
    // α 取决于当前姿态！

1.2 侧滑角 (Sideslip Angle)
    β = asin(v / V_total)
    // v: 侧向速度分量
    // β 取决于当前姿态！

1.3 动压
    q_dynamic = 0.5 × ρ × V²
    // ρ: 空气密度（取决于高度）
    // V: 空速

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第2步：计算气动力系数（基于迎角和舵面）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

2.1 升力系数
    CL = CL_0 + CL_α × α + CL_δe × δe + CL_q × q_norm + CL_δf × δf
    //     基准   迎角贡献   升降舵      俯仰率阻尼    襟翼
    
    关键：CL_α × α  ← 姿态通过迎角直接影响升力！

2.2 阻力系数
    CD = CD_0 + K × CL² + CD_δe × |δe| + CD_δf × δf
    //   基准   诱导阻力   舵面阻力      襟翼阻力

2.3 侧力系数
    CY = CY_β × β + CY_δr × δr
    //   侧滑角     方向舵

2.4 俯仰力矩系数
    Cm = Cm_0 + Cm_α × α + Cm_δe × δe + Cm_q × q_norm
    //   基准   迎角贡献   升降舵      俯仰率阻尼
    
    关键：Cm_α × α  ← 姿态通过迎角影响俯仰力矩！

2.5 滚转力矩系数
    Cl = Cl_β × β + Cl_δa × δa + Cl_p × p_norm + Cl_δr × δr
    //   侧滑角     副翼       滚转率阻尼   方向舵耦合

2.6 偏航力矩系数
    Cn = Cn_β × β + Cn_δr × δr + Cn_r × r_norm + Cn_δa × δa
    //   侧滑角     方向舵     偏航率阻尼   副翼耦合

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第3步：计算气动力和力矩（力 = 系数 × 动压 × 面积）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

3.1 气动力（机体坐标系）
    L = CL × q_dynamic × S        // 升力
    D = CD × q_dynamic × S        // 阻力
    Y = CY × q_dynamic × S        // 侧力
    
    // 转换到机体轴：
    Fx_aero = -D × cos(α) + L × sin(α)
    Fy_aero = Y
    Fz_aero = -D × sin(α) - L × cos(α)

3.2 气动力矩（机体坐标系）
    L_moment = Cl × q_dynamic × S × b    // 滚转力矩
    M_moment = Cm × q_dynamic × S × c    // 俯仰力矩
    N_moment = Cn × q_dynamic × S × b    // 偏航力矩

3.3 推力
    T = f(throttle, altitude, speed, temperature)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第4步：合力和合力矩
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

4.1 总力（机体坐标系）
    Fx_total = T + Fx_aero + Fx_gravity
    Fy_total = Fy_aero + Fy_gravity
    Fz_total = Fz_aero + Fz_gravity

4.2 总力矩（机体坐标系）
    L_total = L_moment + L_other
    M_total = M_moment + M_other
    N_total = N_moment + N_other

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第5步：运动方程积分（更新状态）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

5.1 线加速度（机体坐标系）
    u̇ = Fx_total / m + r×v - q×w
    v̇ = Fy_total / m + p×w - r×u
    ẇ = Fz_total / m + q×u - p×v

5.2 线速度
    u(t+dt) = u(t) + u̇ × dt
    v(t+dt) = v(t) + v̇ × dt
    w(t+dt) = w(t) + ẇ × dt

5.3 角加速度
    ṗ = (L_total × Izz - N_total × Ixz) / (Ixx × Izz - Ixz²)
    q̇ = M_total / Iyy
    ṙ = (N_total × Ixx - L_total × Ixz) / (Ixx × Izz - Ixz²)

5.4 角速度
    p(t+dt) = p(t) + ṗ × dt   // 滚转率
    q(t+dt) = q(t) + q̇ × dt   // 俯仰率
    r(t+dt) = r(t) + ṙ × dt   // 偏航率

5.5 姿态更新 ← 关键！下一帧的气动力基于这个新姿态！
    φ̇ = p + q×sin(φ)×tan(θ) + r×cos(φ)×tan(θ)
    θ̇ = q×cos(φ) - r×sin(φ)
    ψ̇ = (q×sin(φ) + r×cos(φ)) / cos(θ)
    
    φ(t+dt) = φ(t) + φ̇ × dt   // Roll
    θ(t+dt) = θ(t) + θ̇ × dt   // Pitch
    ψ(t+dt) = ψ(t) + ψ̇ × dt   // Yaw

5.6 位置更新
    x(t+dt) = x(t) + Vx × dt
    y(t+dt) = y(t) + Vy × dt
    z(t+dt) = z(t) + Vz × dt

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
输出：新状态 (t+dt)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 新位置: (x', y', z')
  - 新速度: (u', v', w')
  - 新姿态: (φ', θ', ψ')  ← 影响下一帧的迎角！
  - 新角速度: (p', q', r')

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
循环到下一帧，使用新姿态重新计算迎角和气动力！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔄 闭环关系图

```
                    ┌──────────────────┐
                    │   舵面输入       │
                    │  (elevator,      │
                    │   aileron,       │
                    │   rudder)        │
                    └────────┬─────────┘
                             │
                             ↓
                    ┌──────────────────┐
                    │  气动力矩计算    │
                    │  Cm, Cl, Cn      │
                    └────────┬─────────┘
                             │
                             ↓
                    ┌──────────────────┐
                    │  角加速度        │
                    │  ṗ, q̇, ṙ         │
                    └────────┬─────────┘
                             │
                             ↓
                    ┌──────────────────┐
                    │  角速度          │
                    │  p, q, r         │
                    └────────┬─────────┘
                             │
                             ↓
                    ┌──────────────────┐
                    │  姿态角          │
                    │  φ, θ, ψ         │
                    │  (Roll, Pitch,   │
                    │   Yaw)           │
                    └────────┬─────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                  │
            ↓                                  ↓
   ┌──────────────────┐           ┌──────────────────┐
   │  迎角 α          │           │  侧滑角 β        │
   │  α = atan2(w,u)  │           │  β = asin(v/V)   │
   │                  │           │                  │
   │  取决于姿态和    │           │  取决于姿态和    │
   │  机体速度！      │           │  机体速度！      │
   └────────┬─────────┘           └────────┬─────────┘
            │                               │
            └────────────┬──────────────────┘
                         │
                         ↓
                ┌──────────────────┐
                │  气动力系数      │
                │  CL = CL(α, δe)  │← 迎角直接影响升力！
                │  CD = CD(α, δe)  │
                │  Cm = Cm(α, δe)  │← 迎角直接影响力矩！
                │  Cl = Cl(β, δa)  │
                │  Cn = Cn(β, δr)  │
                └────────┬─────────┘
                         │
                         ↓
                ┌──────────────────┐
                │  气动力和力矩    │
                │  L = CL×q×S      │
                │  D = CD×q×S      │
                │  M = Cm×q×S×c    │
                └────────┬─────────┘
                         │
                         ↓
                ┌──────────────────┐
                │  线加速度        │
                │  u̇, v̇, ẇ         │
                └────────┬─────────┘
                         │
                         ↓
                ┌──────────────────┐
                │  线速度          │
                │  u, v, w         │
                └────────┬─────────┘
                         │
                         ↓
                ┌──────────────────┐
                │  位置            │
                │  x, y, z         │
                │  (轨迹)          │
                └──────────────────┘
                         │
                         └─────→ 循环到下一帧
```

---

## 💡 关键洞察

### 1. 姿态 → 迎角的关系

```python
# 机体速度 (u, v, w) 在机体坐标系中
# 但气流相对于机体的角度取决于姿态！

# 例如：
- 飞机平飞 (θ=0°)，速度向前 (u=200, w=0)
  → 迎角 α = atan2(0, 200) = 0°
  → 正常升力

- 升降舵抬头，俯仰角增加 (θ=10°)
  → 机体坐标系中 w 增加（相对气流向上）
  → 迎角 α = atan2(w, u) 增加
  → 升力系数 CL 增加
  → 升力增加！
  → 飞机爬升

- 继续抬头 (θ=25°)，速度降低
  → 迎角 α 继续增加
  → 超过失速迎角 (α_stall ≈ 15-18°)
  → CL 开始下降！
  → 失速！
```

### 2. 舵面的双重作用

```
升降舵抬头 (δe > 0)
  ├─ 直接效应：Cm_δe × δe → 俯仰力矩 → θ 增加
  └─ 间接效应：θ 增加 → α 增加 → CL 增加 → 更多升力

结果：
  - 短期：俯仰力矩使机头抬起
  - 中期：迎角增加，升力增加，开始爬升
  - 长期：速度降低，可能失速
```

### 3. 为什么需要闭环

```
如果没有闭环（假设迎角固定）：
  - 舵面只产生力矩
  - 姿态改变，但气动力不变
  - 不真实！

有了闭环：
  - 舵面产生力矩
  - 姿态改变
  - 迎角改变
  - 气动力改变
  - 速度和轨迹都改变
  - 真实的飞行动力学！
```

---

## 🧪 验证闭环是否工作

### 测试场景：拉杆抬头

```
初始状态：
  - 平飞 700 km/h
  - θ = 0°, α = 2°
  - CL = 0.3
  - 升力 = 飞机重量

按 ↓ (抬头)：
  帧 0: δe=0.5 → Cm增加 → q̇增加 → q增加
  帧 1: q增加 → θ=2° → α=4° → CL=0.4 → L增加
  帧 2: q继续 → θ=5° → α=7° → CL=0.6 → L更大
  帧 3: θ=8° → α=10° → CL=0.8 → 强烈爬升
  帧 4: θ=10° → 速度降低 → 动压降低 → L开始减小
  帧 5: θ=12° → α=14° → 接近失速迎角
  
  松开 ↓：
  帧 6: δe=0 → Cm减小 → q减小 → θ趋于稳定
```

**这就是真实的飞行动力学！**

---

## ✅ JSBSim 的实现

### `fdm.run()` 确保了闭环

JSBSim 的 `run()` 方法每帧都会：

1. ✅ 读取当前姿态 (φ, θ, ψ)
2. ✅ 读取当前速度 (u, v, w)
3. ✅ 计算迎角 α = f(θ, u, w)
4. ✅ 计算气动力系数 CL = f(α, δe)
5. ✅ 计算气动力 L = CL × q × S
6. ✅ 积分更新状态
7. ✅ **下一帧使用新姿态重新计算**

**这是一个完全自洽的闭环系统！**

---

## 🎯 总结

您的理解完全正确：

1. ✅ **舵面** 产生气动力矩
2. ✅ **力矩** 改变飞机姿态
3. ✅ **姿态** 改变迎角和侧滑角
4. ✅ **迎角/侧滑角** 改变气动力系数
5. ✅ **气动力系数** 改变气动力
6. ✅ **气动力** 影响加速度和轨迹
7. ✅ **每一帧都循环**

JSBSim 的 `fdm.run()` 实现了这个完整的闭环，不需要我们手动处理。我们只需要：
- 输入舵面控制
- 读取输出状态
- JSBSim 内部处理所有的气动力学！

**这就是为什么 JSBSim 是高保真飞行动力学模型！** ✈️

